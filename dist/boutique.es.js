var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);function i(t){Object.entries(t).forEach((([e,i])=>{const s=!e.startsWith("__"),h=t[e]instanceof Function;Object.defineProperty(t,e,{value:i,enumerable:s,configurable:s,writable:!h})}))}function s(t,e){for(;t.length>0;)e(t[0]),t.splice(0,1)}class h{constructor(){e(this,"__updateQueue",[]),e(this,"__callbackQueue",[]),e(this,"__requestId"),e(this,"__executeDomUpdates",(()=>{s(this.__updateQueue,(t=>t())),s(this.__callbackQueue,(t=>t()))})),i(this)}__queueDomUpdate(t,e){this.__requestId&&cancelAnimationFrame(this.__requestId),e&&this.__callbackQueue.push(e),this.__updateQueue.push(t),this.__requestId=requestAnimationFrame(this.__executeDomUpdates)}}const n=class extends h{constructor(t,s){super(),e(this,"children",[]),e(this,"__parent"),e(this,"__childSource"),e(this,"__shouldUpdateIndices",[]),e(this,"__shouldAppendIndices",[]),e(this,"__shouldRemoveIndices",[]),this.__parent=t,this.__childSource=s,n.currentNode=this,this.children=this.__isDynamic(this.__childSource)?this.__childSource().map(this.__createChild.bind(this)):this.__childSource.map(this.__createChild.bind(this)),n.currentNode=void 0,i(this)}renderDom(){var t;void 0!==this.__parent.element&&(null==(t=this.__parent.element)||t.append(...this.children.reduce(((t,e)=>{var i,s,h;const n=null==(h=null==(s=(i=e.attributes).$if)?void 0:s.call(i))||h,_=e.renderDom(n);return n?t.concat(_):t}),[])))}updateDom(){const t=this.__parent.element;t&&this.__queueDomUpdate((()=>{try{const e=[];s(this.__shouldRemoveIndices,(i=>{e.push(t.children[i])})),e.forEach((t=>t.remove())),s(this.__shouldUpdateIndices,(e=>t.replaceChild(this.children[e].renderDom(),t.children[e]))),s(this.__shouldAppendIndices,(e=>t.appendChild(this.children[e].renderDom())))}catch(e){}}))}onStateChange(t){if(!this.__isDynamic(this.__childSource))return;const e=this.children.slice(),i=this.__childSource().map((t=>t())),s=Math.max(i.length,e.length),h=[];let n,_,r;for(let a=0;a<s;a++)n=e[a],_=i[a],(null==n?void 0:n.attributes.$key)!==(null==_?void 0:_.attributes.$key)?void 0!==_||void 0===n?void 0!==n||void 0===_?void 0!==n&&void 0!==_&&(r=e.find((t=>!!t.attributes.$key&&t.attributes.$key===_.attributes.$key)),r?h[a]=r:(h[a]=_,this.__shouldUpdateIndices.push(a))):(h[a]=_,this.__shouldAppendIndices.push(a)):this.__shouldRemoveIndices.push(a):h[a]=n;this.children=h,this.updateDom()}__createChild(t){const e=t();return e.parent=this.__parent,e}__isDynamic(t){return"function"==typeof t}};let _=n;e(_,"currentNode");const r=[],a=class extends h{constructor(t,s,h,n=[]){super(),e(this,"parent"),e(this,"element"),e(this,"isFirstRender",!0),e(this,"__attributeState",{$if:!0}),e(this,"__changedStates",[]),e(this,"__boundEffects"),e(this,"__changedAttributes",[]),e(this,"__childNodeList"),e(this,"__doSetStaticAttributes",!0),e(this,"__dynamicAttributes",[]),e(this,"__doRenderDom",!1),e(this,"__mountingElement"),this.tag=t,this.attributes=s,this.__boundEffects=n,h&&(this.__childNodeList=new _(this,h)),this.__setAttributeState(),i(this)}static create(t,e={},i){const s=r.slice();return r.splice(0,r.length),()=>new a(t,e,i,s)}get html(){var t,e,i;return[`<${this.tag}`,Object.entries(this.__attributeState).reduce(((t,[e,i])=>[e.startsWith("$"),e.startsWith("on")].includes(!0)?t:t+` ${this.__getHtmlAttributeName(e)}="${i}"`),""),">",null!=(i=null!=(e=this.__attributeState.$text)?e:null==(t=this.__childNodeList)?void 0:t.children.map((t=>t.html)).join(""))?i:"",`</${this.tag}>`].join("")}get __parentElement(){var t,e;return null!=(e=null==(t=this.parent)?void 0:t.element)?e:this.__mountingElement}get __shouldRemove(){return this.__changedAttributes.includes("$if")&&!1===this.__attributeState.$if}get __shouldAppend(){return this.__changedAttributes.includes("$if")&&!0===this.__attributeState.$if}mount(t){this.__mountingElement=t,t.innerHTML="",t.appendChild(this.renderDom(!0))}renderDom(t=!1){var e;if(!this.isFirstRender)throw new Error("Use update method instead.");return this.__doRenderDom=!0,this.__setAttributeState(),this.element=document.createElement(this.tag),this.__setElementAttributes(),null==(e=this.__childNodeList)||e.renderDom(),this.isFirstRender=!1,t&&this.__queueDomUpdate(this.__dispatchEffects.bind(this)),this.element}updateDom(){this.__doRenderDom&&(this.__queueDomUpdate(this.__setElementAttributes.bind(this),(()=>{s(this.__changedStates,this.__dispatchEffects.bind(this))})),this.__shouldAppend!=this.__shouldRemove&&this.__queueDomUpdate((()=>{var t,e;this.element&&(this.__shouldAppend&&(null==(t=this.__parentElement)||t.appendChild(this.element)),this.__shouldRemove&&(null==(e=this.__parentElement)||e.removeChild(this.element)))}),this.__shouldAppend?()=>this.__dispatchEffects():()=>this.__cleanUpEffects()))}onStateChange(t){this.__changedStates.push(t),this.__setAttributeState(),this.updateDom()}__setElementAttributes(){if(!this.element)return;(this.isFirstRender?Object.keys(this.__attributeState):this.__changedAttributes).forEach((t=>{const e=this.__attributeState[t];"$html"!==t?"$text"!==t?"on"!==t.substr(0,2)?"$"!==t[0]&&this.element.setAttribute(this.__getHtmlAttributeName(t),e):this.element[t]=e:this.element.innerText=null!=e?String(e):"":this.element.innerHTML=null!=e?String(e):""}))}__setAttributeState(){let t,e;a.currentNode=this,this.__changedAttributes.splice(0,this.__changedAttributes.length),this.__doSetStaticAttributes?Object.entries(this.attributes).forEach((([i,s])=>{e=this.__isDynamicAttribute(i,s),t=e?s():s,this.__handleNewAttributeValue(i,t)})):this.__dynamicAttributes.forEach((e=>{t=this.attributes[e](),this.__handleNewAttributeValue(e,t)})),a.currentNode=void 0,this.__doSetStaticAttributes=!1}__handleNewAttributeValue(t,e){e!==this.__attributeState[t]&&(this.__changedAttributes.push(t),this.__attributeState[t]=e)}__dispatchEffects(t){this.__boundEffects.forEach((e=>e.dispatch(t)))}__cleanUpEffects(){this.__boundEffects.forEach((t=>t.cleanup()))}__isDynamicAttribute(t,e){return("$if"===t||"on"!==t.substr(0,2)&&"function"==typeof e)&&(this.__dynamicAttributes.push(t),!0)}__getHtmlAttributeName(t){switch(t){case"className":return"class"}return t.split(/(?=[A-Z])/).map((t=>t.toLowerCase())).join("-")}};let u=a;e(u,"currentNode");const c=t=>u.create.bind(void 0,t),d=c("div"),l=c("h1");class o{constructor(t){e(this,"__boundNodes",[]),e(this,"__internalState"),e(this,"__listeners",[]),this.__internalState=t,i(this)}get state(){const t=this.__boundNodes,e=u.currentNode,i=_.currentNode;return e&&!t.includes(e)&&t.push(e),i&&!t.includes(i)&&t.push(i),this.__internalState}set state(t){t!==this.__internalState&&(this.__internalState=t,this.__listeners.forEach((t=>t(this))),this.__boundNodes.forEach((t=>t.onStateChange(this))))}set(t){this.state=t(this.__internalState)}addListener(t){return this.__listeners.push(t),this}}function p(t){return new o(t instanceof Function?t():t)}class m{constructor(t,s){e(this,"__callback"),e(this,"__cleanup"),e(this,"__watch"),this.__callback=t,this.__watch=s,i(this)}static isEffect(t){var e;return"Effect"===(null==(e=t.constructor)?void 0:e.name)}dispatch(t){t&&this.__watch&&!this.__watch.includes(t)||(this.__cleanup=this.__callback())}cleanup(){var t;null==(t=this.__cleanup)||t.call(this)}}function b(t,e){"function"==typeof t?r.push(new m(t)):e&&r.push(new m(e,t))}export{m as Effect,o as State,d as div,b as effect,l as h1,p as state};
